# rust_db

## 基本架构

本数据库基本由三个层次组成，语法解析层（Parser），查询处理层(Query Procession)，存储引擎层（Storage Engine）。

main函数的执行流程为，首先读取数据库文件，将文件内容保存在底层的数据结构中。之后循环获取要执行的语句，通过语法解析层生成ast树，将ast树传入查询处理层，查询处理层会具体执行该语句。

## 详细架构

src/
├── main.rs                        # 程序入口
├── error.rs                       # 统一错误处理
├── parser/                        # 语法解析层
│   ├── mod.rs
│   ├── sql_parser.rs              # SQL解析
│   └── ast.rs                     # 自定义AST结构（如需要）
│
├── query/                         # 查询处理层
│   ├── mod.rs
│   ├── planner.rs                 # 查询计划生成
│   ├── optimizer.rs               # 查询优化
│   ├── executor/                  # 执行器
│   │   ├── mod.rs
│   │   ├── ddl_executor.rs        # DDL执行
│   │   ├── dml_executor.rs        # DML执行
│   │   └── query_executor.rs      # 查询执行
│   └── result.rs                  # 查询结果处理
│
└── storage/                       # 存储引擎层
    ├── mod.rs
    ├── engine.rs                  # 存储引擎实现
    ├── transaction.rs             # 事务管理
    ├── table.rs                   # 表管理
    ├── record.rs                  # 记录管理
    ├── index.rs                   # 索引实现
    ├── catalog.rs                 # 元数据管理
    └── io/                        # IO管理
        ├── mod.rs
        ├── page.rs                # 页面管理
        └── persistence.rs         # 持久化实现

## 层与层之间的交互模式

``` text
┌───────────┐        Parse SQL       ┌─────────────┐    Generate Query Plan    ┌──────────────┐
│           │───────────────────────>│    Query    │──────────────────────────>│    Storage   │
│  Parser   │     Return AST Tree    │  Processing │    Execute Storage Ops    │    Engine    │
│           │<──────────────────────-│             │<─────────────────────────-│              │
└───────────┘                        └─────────────┘      Return Results       └──────────────┘
```

## 基础功能

- 记录数据类型：int，varchar；
- 支持单行与多行注释；
- 支持记录的增删改查，即select，insert，update，delete；
- 支持数据表的create，drop；
- 持久化存储引擎
- 执行引擎，可读入SQL执行，返回表结果或报错信息
- 支持cargo test

## 编译构建

使用cargo即可。

## 输入

允许且仅允许系统输入单个参数，为内含sql语句的txt文件路径。

## 数据结构

1. 数据库链表。该链表包含多个打开的数据库。

2. 数据库结构。一个数据库结构由以下部分组成：一个数据库头结构，一个模板结构，一个记录链表结构。数据库头结构包含以下信息：数据库的名称，数据库的记录数量等。模板结构是一个模板单元的链表，记录链表结构是一个记录的链表。
**注：考虑到rust的所有权系统，这里可以尽量使用Vec实现。对于频繁查找的内容使用HashMap或BTreeMap。**

3. 模板单元结构。该结构包含单元类型，该属性名称，模板单元属性信息。其中模板单元属性信息又包括：是否可设置为空，是否为主键，是否设置索引，是否unique，具体记录内容的最大位数等。

4. 记录结构。该结构包含该记录的唯一索引值和一个记录单元链表。记录单元链表是记录单元结构的链表。

5. 记录单元结构。该结构包含单元类型记录的属性具体的值，记录单元属性信息，其中单元属性信息又包括：是否为空，具体的位数等。

## 存储引擎层

存储引擎层是唯一能调用保存的数据结构的层级，该层主要有六个函数：

create函数用于创建一个数据库结构。该函数接受一个字符串类型和一个数据库模板，根据该模板链表创建一个数据库，返回这个新创建的数据库，如果创建失败返回空。
**注：这里可使用rust的错误处理，使用Result<T, E>表示可能失败的操作，下同。**

drop函数用于删除一个数据库结构。该函数接受一个字符串类型，为要删除的数据库的名称，之后找到对应的数据库进行删除，若成功删除返回1，否则返回0。

firstLog函数用于获取该数据库的第一条记录。该函数接受一个数据库，返回该数据库的第一条记录，若该数据库没有记录则返回空。

getLog函数用于获取该数据库已获得记录的下一条记录。该函数接受一个数据库和一条该数据库中的记录，返回该数据库中该条记录的下一条记录，若没有下一条记录则返回空。
**注：或许可以实现Iterator特征，并使用特征中的next函数实现**

insertLog函数用于创建一条新记录。该函数接受一个数据库和一条记录中各个属性的值，该函数新建一条对应的记录，并将该条记录插入到这个数据库中。

deleteLog函数用于删除一条记录。该函数接受一个数据库和数据库中的一条记录，将这条记录从这个数据库中删除。

## 查询处理层

查询处理层获取要执行的ast树的节点，然后解析该ast树，根据树的不同调用不同的存储引擎层命令获取调用结果，再根据调用结果进行输出。

该层还有一个辅助函数satisfy函数，该函数接受一条记录和一个ast节点（条件语句），判断该语句是否满足该ast节点所对应的条件。

where函数接受一个ast树，返回一个链表，该链表包含满足条件的所有记录。该函数调用firstLog获取数据库的第一条记录，之后循环调用getLog获取下一条记录，对于每条记录调用satisfy函数判断是否满足，若满足则加到链表里。
